name: Build Kernel 4.9 with GCC 10.1.0 and KernelSU-Next

on: workflow_dispatch: inputs: kernel_source: description: "Kernel source repository URL" required: true type: string kernel_branch: description: "Kernel branch to checkout" required: true type: string kernelsu_branch: description: "KernelSU-Next branch" required: true type: string anykernel_repo: description: "AnyKernel3 repository URL" required: true type: string anykernel_branch: description: "AnyKernel3 branch" required: true type: string

jobs: build: runs-on: ubuntu-20.04

steps:
  - name: Checkout kernel source
    uses: actions/checkout@v4
    with:
      repository: ${{ github.event.inputs.kernel_source }}
      ref: ${{ github.event.inputs.kernel_branch }}
      path: kernel

  - name: Install dependencies
    run: |
      sudo apt update
      sudo apt install -y build-essential bc bison flex libssl-dev libncurses5-dev ccache libelf-dev gcc-10 g++-10

  - name: Set GCC 10 as default
    run: |
      export CC=gcc-10
      export CXX=g++-10
      echo "Using GCC version:" $(gcc-10 --version)

  - name: Set up KernelSU-Next
    run: |
      cd kernel
      curl -LSs "https://raw.githubusercontent.com/FirmanBell/KernelSU-Next/ngawur/kernel/setup.sh" | bash -s ngawur

  - name: Configure kernel
    run: |
      cd kernel
      make ARCH=arm64 O=out defconfig

  - name: Build kernel
    run: |
      cd kernel
      make -j$(nproc) ARCH=arm64 O=out CC=gcc-10

  - name: Clone AnyKernel3
    run: |
      git clone --branch ${{ github.event.inputs.anykernel_branch }} ${{ github.event.inputs.anykernel_repo }} anykernel

  - name: Copy Image.gz and dtb to AnyKernel3
    run: |
      cp kernel/out/arch/arm64/boot/Image.gz anykernel/
      cp kernel/out/arch/arm64/boot/dts/*.dtb anykernel/
      cp kernel/out/arch/arm64/boot/dts/*.dtbo anykernel/ || true

  - name: Pack flashable zip
    run: |
      cd anykernel
      zip -r9 ../Kernel-Flashable.zip .

  - name: Upload artifact
    uses: actions/upload-artifact@v4
    with:
      name: kernel-flashable-zip
      path: Kernel-Flashable.zip
